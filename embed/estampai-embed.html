<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstampAI - Gerador de Estampas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .embed-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #1A237E;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }
        
        .chat-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .chat-header h3 {
            color: #1A237E;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 20px;
            max-height: 400px;
        }
        
        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: #1A237E;
            color: white;
        }
        
        .message.ai .message-avatar {
            background: #f3e5f5;
            color: #1A237E;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .message.user .message-content {
            background: #1A237E;
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        
        .message.ai .message-content {
            background: white;
            color: #333;
            border-radius: 18px 18px 18px 4px;
            border: 1px solid #e0e0e0;
        }
        
        .input-area {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            resize: vertical;
            min-height: 48px;
            max-height: 120px;
            font-family: inherit;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #1A237E;
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .btn-primary {
            background: #1A237E;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0d47a1;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #4CAF50;
            color: white;
            font-size: 12px;
            padding: 10px 16px;
        }
        
        .btn-secondary:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .results-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .results-header h3 {
            color: #1A237E;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .view-tabs {
            display: flex;
            gap: 8px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .tab-btn.active {
            background: #1A237E;
            color: white;
            border-color: #1A237E;
        }
        
        .preview-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .preview-canvas {
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        
        .stamp-overlay {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 120px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .download-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }
        
        .download-btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .download-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .download-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #666;
            font-size: 14px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e0e0e0;
            border-top: 2px solid #1A237E;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin: 16px 0;
        }
        
        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin: 16px 0;
        }
        
        .watermark {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            color: #1A237E;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(26, 35, 126, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .watermark:hover {
            background: rgba(26, 35, 126, 0.95);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .watermark-text {
            font-weight: 400;
        }
        
        .watermark-brand {
            font-weight: 600;
        }
        
        .watermark-arrow {
            font-size: 10px;
            opacity: 0.7;
            transition: transform 0.3s ease;
        }
        
        .watermark:hover .watermark-arrow {
            transform: translateX(2px);
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .chat-section,
            .results-section {
                height: 550px;
            }
        }
        
        @media (max-width: 768px) {
            .embed-container {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .chat-section,
            .results-section {
                height: 500px;
                padding: 20px;
            }
            
            .messages-container {
                max-height: 300px;
            }
            
            .message-content {
                max-width: 85%;
                font-size: 13px;
            }
            
            .input-field {
                font-size: 13px;
            }
            
            .btn {
                font-size: 13px;
                padding: 10px 16px;
            }
        }
        
        @media (max-width: 480px) {
            .embed-container {
                padding: 12px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .chat-section,
            .results-section {
                padding: 16px;
                height: 450px;
            }
            
            .chat-header h3,
            .results-header h3 {
                font-size: 1.1rem;
            }
            
            .messages-container {
                max-height: 250px;
                padding: 12px;
            }
            
            .message-content {
                max-width: 90%;
                font-size: 12px;
                padding: 10px 12px;
            }
            
            .input-area {
                flex-direction: column;
                gap: 8px;
            }
            
            .input-field {
                font-size: 12px;
                min-height: 40px;
            }
            
            .btn {
                width: 100%;
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .preview-container {
                height: 300px;
            }
            
            .preview-canvas {
                max-width: 100%;
                max-height: 100%;
            }
            
            .stamp-overlay {
                width: 80px;
                height: 80px;
            }
            
            .watermark {
                bottom: 10px;
                right: 10px;
                font-size: 10px;
                padding: 6px 8px;
            }
        }
        
        /* Touch optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                touch-action: manipulation;
            }
            
            .input-field {
                min-height: 44px;
            }
            
            .tab-btn {
                min-height: 44px;
                padding: 12px 16px;
            }
        }
        
        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .preview-canvas {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }
    </style>
</head>
<body>
    <div class="embed-container">
        <div class="header">
            <h1>🎨 EstampAI</h1>
            <p>Crie estampas únicas com inteligência artificial. Converse com nossa IA e veja suas ideias ganharem vida!</p>
        </div>
        
        <div class="main-content">
            <!-- Chat Section -->
            <div class="chat-section">
                <div class="chat-header">
                    <h3>💬 Chat com IA</h3>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div class="message ai">
                        <div class="message-avatar">🤖</div>
                        <div class="message-content">
                            Olá! 👋 Sou a EstampAI, sua assistente para criação de estampas! Conte-me sobre sua ideia: que tipo de estampa você gostaria de criar? Pode ser qualquer coisa - desde símbolos simples até ilustrações complexas!
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <textarea 
                        class="input-field" 
                        id="messageInput" 
                        placeholder="Conte-me sobre sua ideia de estampa..."
                        rows="2"
                    ></textarea>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
                        <button class="btn btn-secondary" onclick="generateStamp()">🎨 Gerar</button>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="results-section">
                <div class="results-header">
                    <h3>🎯 Resultado</h3>
                    <div class="view-tabs">
                        <button class="tab-btn active" onclick="showView('avatar')">👤 Avatar</button>
                        <button class="tab-btn" onclick="showView('stamp')">🎨 Estampa</button>
                    </div>
                </div>
                
                <div class="preview-container">
                    <canvas id="avatarCanvas" class="preview-canvas" width="400" height="500" style="display: block;"></canvas>
                    <canvas id="stampCanvas" class="preview-canvas" width="400" height="400" style="display: none;"></canvas>
                    
                    <div id="loadingMessage" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <span>Gerando sua estampa...</span>
                    </div>
                </div>
                
                <div class="download-section">
                    <button class="download-btn" id="downloadBtn" onclick="downloadStamp()" disabled>
                        📥 Baixar Estampa
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="watermark" onclick="showPortfolio()">
        <span class="watermark-text">Powered by</span>
        <span class="watermark-brand">EstampAI</span>
        <span class="watermark-arrow">→</span>
    </div>

    <!-- Integração dos sistemas -->
    <script src="config.js?v=2"></script>
    <script src="cache-manager.js?v=2"></script>
    <script src="api-optimizer.js?v=2"></script>
    <script src="rate-limiter.js?v=2"></script>
    <script src="analytics.js?v=2"></script>
    <script src="lead-capture.js?v=2"></script>
    
    <script>
        // Configuração
        const CONFIG = {
            apiKey: window.OPENAI_API_KEY || 'YOUR_OPENAI_API_KEY_HERE',
            maxStamps: 3, // Freemium limit
            cacheEnabled: true,
            analyticsEnabled: true,
            rateLimitEnabled: true
        };
        
        // Estado da aplicação
        let conversationHistory = [];
        let currentStamp = null;
        let stampsGenerated = 0;
        let isGenerating = false;
        let userId = null;
        
        // Sistemas integrados
        let stampCache = null;
        let apiOptimizer = null;
        let rateLimiter = null;
        let analytics = null;
        
        // Analytics
        function trackEvent(event, data = {}) {
            if (!CONFIG.analyticsEnabled) return;
            
            console.log('📊 Analytics:', event, data);
            // Aqui você pode integrar com Google Analytics, Mixpanel, etc.
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Inicializa sistemas
                await initializeSystems();
                
                // Configura UI
                loadAvatar();
                setupEventListeners();
                
                // Analytics
                if (analytics) {
                    analytics.trackEmbedLoaded();
                }
                
                console.log('✅ EstampAI Embed inicializado com sucesso');
            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
            }
        });
        
        async function initializeSystems() {
            // Gera ID do usuário
            userId = generateUserId();
            
            // Inicializa cache
            if (CONFIG.cacheEnabled && window.stampCache) {
                stampCache = window.stampCache;
                await stampCache.init();
                console.log('✅ Cache inicializado');
            }
            
            // Inicializa otimizador de API
            if (window.apiOptimizer) {
                apiOptimizer = window.apiOptimizer;
                console.log('✅ API Optimizer inicializado');
            }
            
            // Inicializa rate limiter
            if (CONFIG.rateLimitEnabled && window.rateLimiter) {
                rateLimiter = window.rateLimiter;
                console.log('✅ Rate Limiter inicializado');
            }
            
            // Inicializa analytics
            if (CONFIG.analyticsEnabled && window.analytics) {
                analytics = window.analytics;
                console.log('✅ Analytics inicializado');
            }
        }
        
        function generateUserId() {
            let userId = localStorage.getItem('estampai_user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('estampai_user_id', userId);
            }
            return userId;
        }
        
        function setupEventListeners() {
            const input = document.getElementById('messageInput');
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            input.addEventListener('input', function() {
                // Auto-resize textarea
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }
        
        function loadAvatar() {
            const canvas = document.getElementById('avatarCanvas');
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = 'https://estampai.onrender.com/AVATAR.png';
        }
        
        function addMessage(type, content) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatar = type === 'user' ? '👤' : '🤖';
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content}</div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // Adiciona ao histórico
            conversationHistory.push({
                role: type === 'user' ? 'user' : 'assistant',
                content: content,
                timestamp: new Date()
            });
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loadingMessage');
            const avatarCanvas = document.getElementById('avatarCanvas');
            const stampCanvas = document.getElementById('stampCanvas');
            
            if (show) {
                loading.style.display = 'flex';
                avatarCanvas.style.display = 'none';
                stampCanvas.style.display = 'none';
            } else {
                loading.style.display = 'none';
                avatarCanvas.style.display = 'block';
                stampCanvas.style.display = 'none';
            }
        }
        
        function showView(view) {
            // Atualiza tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Mostra canvas correto
            const avatarCanvas = document.getElementById('avatarCanvas');
            const stampCanvas = document.getElementById('stampCanvas');
            
            if (view === 'avatar') {
                avatarCanvas.style.display = 'block';
                stampCanvas.style.display = 'none';
            } else {
                avatarCanvas.style.display = 'none';
                stampCanvas.style.display = 'block';
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isGenerating) return; isGenerating = true;
            
            // Verifica rate limiting
            if (rateLimiter) {
                const rateCheck = rateLimiter.canProceed(userId, 'chat');
                if (!rateCheck.allowed) {
                    const resetTime = new Date(rateCheck.resetTime);
                    addMessage('ai', `Muitas mensagens! Tente novamente em ${resetTime.toLocaleTimeString()}`);
                    return;
                }
            }
            
            // Adiciona mensagem do usuário
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';
            
            // Mostra loading
            addMessage('ai', '🤔 Pensando...');
            
            try {
                // Chat com IA (com debounce)
                const debouncedChat = apiOptimizer && typeof apiOptimizer.debounce === 'function' ? 
                    apiOptimizer.debounce(chatWithAI, 500) : 
                    chatWithAI;
                
                const response = await debouncedChat(message);
                
                // Remove loading e adiciona resposta
                const messages = document.getElementById('messagesContainer');
                if (messages && messages.lastChild) { messages.removeChild(messages.lastChild); }
                addMessage('ai', response);
                
                // Analytics
                if (analytics) {
                    analytics.trackMessageSent(message);
                }
                
            } catch (error) {
                console.error('Erro no chat:', error);
                const messages = document.getElementById('messagesContainer');
                if (messages && messages.lastChild) { messages.removeChild(messages.lastChild); }
                addMessage('ai', 'Desculpe, estou com dificuldades técnicas. Tente novamente!');
                
                // Analytics de erro
                if (analytics) {
                    analytics.trackError(error, 'chat');
                }
            }
        }
        
        async function generateStamp() {
            if (isGenerating) return;
            
            // Verifica rate limiting
            if (rateLimiter) {
                const rateCheck = rateLimiter.canProceed(userId, 'stamp');
                if (!rateCheck.allowed) {
                    const resetTime = new Date(rateCheck.resetTime);
                    addMessage('ai', `Muitas estampas geradas! Tente novamente em ${resetTime.toLocaleTimeString()}`);
                    return;
                }
            }
            
            // Verifica limite freemium
            if (stampsGenerated >= CONFIG.maxStamps) {
                addMessage('ai', `Você já gerou ${CONFIG.maxStamps} estampas gratuitas! Entre em contato para gerar mais.`);
                return;
            }
            
            isGenerating = true;
            showLoading(true);
            
            try {
                // Extrai contexto da conversa
                const prompt = await extractStampContext();
                if (!prompt) {
                    addMessage('ai', 'Preciso de mais detalhes! Me conte sobre o que você quer na estampa: dragão, caveira, símbolo, etc.');
                    showLoading(false);
                    isGenerating = false;
                    return;
                }
                
                // Verifica cache primeiro
                let imageUrl = null;
                if (stampCache) {
                    const cachedStamp = await stampCache.getCachedStamp(prompt);
                    if (cachedStamp) {
                        imageUrl = cachedStamp.imageUrl;
                        console.log('🎯 Usando estampa do cache');
                    }
                }
                
                // Gera estampa se não encontrou no cache
                if (!imageUrl) {
                    imageUrl = await generateStampWithAI(prompt);
                    
                    // Salva no cache
                    if (stampCache) {
                        await stampCache.saveStamp(prompt, imageUrl, {
                            userId: userId,
                            timestamp: Date.now()
                        });
                    }
                }
                
                // Aplica no avatar
                applyStampToAvatar(imageUrl);
                
                // Atualiza contador
                stampsGenerated++;
                currentStamp = imageUrl;
                
                // Habilita download
                document.getElementById('downloadBtn').disabled = false;
                
                addMessage('ai', '✨ Pronto! Sua estampa foi criada! Veja como ficou no avatar.');
                
                // Analytics
                if (analytics) {
                    analytics.trackStampGenerated(prompt, true);
                }
                
            } catch (error) {
                console.error('Erro ao gerar estampa:', error);
                addMessage('ai', 'Desculpe, não consegui gerar sua estampa. Tente novamente!');
                
                // Analytics de erro
                if (analytics) {
                    analytics.trackError(error, 'stamp_generation');
                }
            } finally {
                showLoading(false);
                isGenerating = false;
            }
        }
        
        async function chatWithAI(message) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4',
                    messages: [
                        {
                            role: 'system',
                            content: `Você é a EstampAI, uma assistente especializada em criação de estampas para camisetas. 

Sua personalidade:
- Criativa e entusiasmada
- Conhece tendências de moda e streetwear
- Ajuda a refinar ideias de estampas
- Faz perguntas para entender melhor o que o usuário quer
- Sugere melhorias e variações

IMPORTANTE: Só sugira gerar a estampa quando o usuário mencionar elementos específicos como:
- Dragão, caveira, cruz, fogo, moto, carro, brasão, símbolo, logo, ícone
- Ou quando o usuário explicitamente pedir para gerar

Quando o usuário mencionar uma ideia de estampa:
1. Faça perguntas para entender melhor (estilo, cores, público-alvo)
2. Sugira melhorias ou variações
3. Só pergunte se quer gerar quando tiver elementos específicos

Seja conversacional e amigável!`
                        },
                        ...conversationHistory.filter(msg => msg && msg.role && msg.content).slice(-10)
                    ],
                    max_tokens: 300,
                    temperature: 0.8
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text().catch(() => 'Erro desconhecido'); throw new Error(`Erro da API: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        async function extractStampContext() {
            if (conversationHistory.length < 2) {
                return conversationHistory[conversationHistory.length - 1]?.content || '';
            }
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            {
                                role: 'system',
                                content: `Você é um especialista em extrair informações relevantes para criação de estampas.

Sua tarefa: Analisar a conversa e extrair APENAS os elementos visuais específicos que devem aparecer na estampa.

INSTRUÇÕES:
1. Identifique elementos visuais específicos (objetos, pessoas, animais, símbolos, etc.)
2. Identifique estilo visual (vintage, minimalista, realista, cartoon, etc.)
3. Identifique cores mencionadas
4. Identifique composição (centralizada, grande, pequena, etc.)
5. IGNORE informações sobre público-alvo, marca, negócio, etc.

FORMATO DE RESPOSTA:
Se houver elementos visuais específicos, retorne APENAS uma descrição concisa dos elementos visuais.
Se NÃO houver elementos visuais específicos, retorne "INSUFICIENTE".

EXEMPLOS:
- "dragão flamejante em estilo vintage"
- "caveira punk com espinhos em preto e branco"
- "jogador de futebol em estádio com bandeiras do Brasil no estilo pôster vintage"
- "INSUFICIENTE" (se só mencionar "marca", "negócio", "público-alvo", etc.)`
                            },
                            {
                                role: 'user',
                                content: `Analise esta conversa e extraia os elementos visuais para estampa:\n\n${conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}`
                            }
                        ],
                        max_tokens: 100,
                        temperature: 0.3
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Erro desconhecido'); throw new Error(`Erro da API: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                const extractedPrompt = data.choices[0].message.content.trim();
                
                if (extractedPrompt === 'INSUFICIENTE') {
                    return null;
                }
                
                return extractedPrompt;
                
            } catch (error) {
                console.error('Erro ao extrair contexto:', error);
                const userMessages = conversationHistory
                    .filter(msg => msg.role === 'user')
                    .map(msg => msg.content)
                    .join(' ');
                return userMessages;
            }
        }
        
        async function generateStampWithAI(prompt) {
            // Otimiza prompt se disponível
            const optimizedPrompt = apiOptimizer && typeof apiOptimizer.debounce === 'function' ? 
                apiOptimizer.optimizePrompt(prompt) : 
                prompt;
            
            const fullPrompt = `Isolated illustration of ${optimizedPrompt}

Background: SOLID BLACK

Technical specifications:
- Format: Square 1024x1024px
- Resolution: High quality (HD)
- Style: Modern, dynamic and versatile
- Colors: Vibrant and contrasting
- Composition: Centered and balanced

DO NOT include:
- T-shirt, clothing, mockup, product or mannequin
- Colored or patterned background
- Text or typography
- Borders or frames
- Product design elements
- Any clothing or fabric

RESULT: Isolated illustration, solid black background, high quality, perfect for t-shirt printing.`;
            
            // Usa retry com backoff se disponível
            const makeRequest = () => fetch('https://api.openai.com/v1/images/generations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: 'dall-e-3',
                    prompt: fullPrompt,
                    n: 1,
                    size: '1024x1024',
                    response_format: 'url'
                })
            });
            
            const response = apiOptimizer && typeof apiOptimizer.debounce === 'function' ? 
                await apiOptimizer.retryRequest(makeRequest) : 
                await makeRequest();
            
            if (!response.ok) {
                const errorText = await response.text().catch(() => 'Erro desconhecido'); throw new Error(`Erro da API: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            return data.data[0].url;
        }
        
        function applyStampToAvatar(imageUrl) {
            const container = document.querySelector('.preview-container');
            
            // Remove estampa anterior
            const existingStamp = document.getElementById('stampOverlay');
            if (existingStamp) {
                existingStamp.remove();
            }
            
            // Cria nova estampa
            const stampImg = document.createElement('img');
            stampImg.id = 'stampOverlay';
            stampImg.className = 'stamp-overlay';
            stampImg.src = imageUrl;
            stampImg.alt = 'Estampa gerada';
            
            stampImg.onload = function() {
                console.log('✅ Estampa aplicada no avatar');
            };
            
            stampImg.onerror = function() {
                console.error('❌ Erro ao carregar estampa');
                stampImg.remove();
            };
            
            container.appendChild(stampImg);
            
            // Também desenha no canvas de estampa
            const stampCanvas = document.getElementById('stampCanvas');
            const ctx = stampCanvas.getContext('2d');
            const canvasImg = new Image();
            canvasImg.onload = function() {
                ctx.clearRect(0, 0, stampCanvas.width, stampCanvas.height);
                ctx.drawImage(canvasImg, 0, 0, stampCanvas.width, stampCanvas.height);
            };
            canvasImg.src = imageUrl;
        }
        
        function downloadStamp() {
            if (!currentStamp) return;
            
            const link = document.createElement('a');
            link.href = currentStamp;
            link.download = `estampa-${Date.now()}.png`;
            link.click();
            
            // Analytics
            if (analytics) {
                analytics.trackStampDownloaded();
            }
            
            // Conversão
            if (analytics) {
                analytics.trackConversion('download', 1);
            }
        }
        
        function showPortfolio() {
            // Analytics
            if (analytics) {
                analytics.track('portfolio_clicked');
            }
            
            // Abre portfólio em nova aba
            window.open('https://seu-portfolio.com', '_blank');
        }
    </script>
</body>
</html>
