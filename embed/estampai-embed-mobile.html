<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstampAI - Gerador de Estampas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: #ffffff;
            line-height: 1.4;
            overflow-x: hidden;
        }
        
        .embed-container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: #000000;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding: 0 15px;
        }
        
        .header h1 {
            font-size: 1.6rem;
            color: #ffffff;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        
        .header p {
            font-size: 0.9rem;
            color: #888888;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 0 15px;
            height: 350px;
        }
        
        .chat-section {
            background: #111111;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.1);
            border: 1px solid #333333;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333333;
        }
        
        .chat-header h3 {
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #0a0a0a;
            border-radius: 8px;
            margin-bottom: 15px;
            max-height: 120px;
            border: 1px solid #222222;
        }
        
        .message {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.5);
        }
        
        .message.ai .message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 0 8px rgba(240, 147, 251, 0.5);
        }
        
        .message-content {
            max-width: 85%;
            padding: 10px 12px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 4px 12px;
            box-shadow: 0 1px 6px rgba(102, 126, 234, 0.3);
        }
        
        .message.ai .message-content {
            background: #1a1a1a;
            color: #ffffff;
            border-radius: 12px 12px 12px 4px;
            border: 1px solid #333333;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.3);
        }
        
        .input-area {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .input-field {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #333333;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 44px;
            max-height: 80px;
            font-family: inherit;
            background: #0a0a0a;
            color: #ffffff;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .input-field::placeholder {
            color: #666666;
        }
        
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 11px;
            padding: 10px 14px;
            box-shadow: 0 2px 8px rgba(240, 147, 251, 0.4);
        }
        
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(240, 147, 251, 0.6);
        }
        
        .results-section {
            background: #111111;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.1);
            border: 1px solid #333333;
            height: 200px;
            display: flex;
            flex-direction: column;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333333;
        }
        
        .results-header h3 {
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .view-tabs {
            display: flex;
            gap: 6px;
        }
        
        .tab-btn {
            padding: 8px 12px;
            border: 1px solid #333333;
            background: #0a0a0a;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #888888;
            min-height: 36px;
            touch-action: manipulation;
        }
        
        .tab-btn:hover {
            background: #1a1a1a;
            color: #ffffff;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 1px 6px rgba(102, 126, 234, 0.3);
        }
        
        .preview-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #0a0a0a;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            border: 1px solid #222222;
        }
        
        .preview-canvas {
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            max-width: 100%;
            max-height: 100%;
        }
        
        .stamp-overlay {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
            z-index: 10;
        }
        
        .download-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333333;
            text-align: center;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(240, 147, 251, 0.4);
            min-height: 44px;
            touch-action: manipulation;
        }
        
        .download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(240, 147, 251, 0.6);
        }
        
        .download-btn:disabled {
            background: #333333;
            color: #666666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #888888;
            font-size: 13px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #333333;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #2d1b1b;
            color: #ff6b6b;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 12px;
            margin: 10px 0;
            border: 1px solid #4a2c2c;
        }
        
        .success-message {
            background: #1b2d1b;
            color: #51cf66;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 12px;
            margin: 10px 0;
            border: 1px solid #2c4a2c;
        }
        
        /* Glow effects */
        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
            }
            to {
                box-shadow: 0 0 25px rgba(102, 126, 234, 0.6);
            }
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .main-content {
                height: 320px;
                padding: 0 10px;
            }
            
            .chat-section,
            .results-section {
                padding: 15px;
            }
            
            .messages-container {
                max-height: 100px;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .input-field {
                font-size: 13px;
                padding: 10px 12px;
            }
            
            .btn {
                font-size: 11px;
                padding: 10px 14px;
            }
        }
        
        /* Touch optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                touch-action: manipulation;
            }
            
            .input-field {
                min-height: 44px;
            }
            
            .tab-btn {
                min-height: 44px;
                padding: 10px 12px;
            }
            
            .download-btn {
                min-height: 44px;
            }
        }
        
        /* Scrollbar styling */
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: #0a0a0a;
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: #333333;
            border-radius: 3px;
        }
        
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }
    </style>
</head>
<body>
    <div class="embed-container">
        <div class="header">
            <h1 class="glow">🎨 EstampAI</h1>
            <p>Crie estampas únicas com IA</p>
        </div>
        
        <div class="main-content">
            <!-- Chat Section -->
            <div class="chat-section">
                <div class="chat-header">
                    <h3>💬 Chat</h3>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div class="message ai">
                        <div class="message-avatar">🤖</div>
                        <div class="message-content">
                            Olá! Conte-me sobre sua estampa!
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <textarea 
                        class="input-field" 
                        id="messageInput" 
                        placeholder="Descreva sua estampa..."
                        rows="1"
                    ></textarea>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
                        <button class="btn btn-secondary" onclick="generateStamp()">🎨</button>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="results-section">
                <div class="results-header">
                    <h3>🎯 Resultado</h3>
                    <div class="view-tabs">
                        <button class="tab-btn active" onclick="showView('avatar')">👤</button>
                        <button class="tab-btn" onclick="showView('stamp')">🎨</button>
                    </div>
                </div>
                
                <div class="preview-container">
                    <canvas id="avatarCanvas" class="preview-canvas" width="200" height="250" style="display: block;"></canvas>
                    <canvas id="stampCanvas" class="preview-canvas" width="200" height="200" style="display: none;"></canvas>
                    
                    <div id="loadingMessage" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <span>Gerando...</span>
                    </div>
                </div>
                
                <div class="download-section">
                    <button class="download-btn" id="downloadBtn" onclick="downloadStamp()" disabled>
                        📥 Baixar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Integração dos sistemas -->
    <script src="config.js?v=2"></script>
    <script src="cache-manager.js?v=2"></script>
    <script src="api-optimizer.js?v=2"></script>
    <script src="rate-limiter.js?v=2"></script>
    <script src="analytics.js?v=2"></script>
    <script src="lead-capture.js?v=2"></script>
    
    <script>
        // Configuração
        const CONFIG = {
            apiKey: window.OPENAI_API_KEY || 'YOUR_OPENAI_API_KEY_HERE',
            maxStamps: 3, // Freemium limit
            cacheEnabled: true,
            analyticsEnabled: true,
            rateLimitEnabled: true
        };
        
        // Estado da aplicação
        let conversationHistory = [];
        let currentStamp = null;
        let stampsGenerated = 0;
        let isGenerating = false;
        let userId = null;
        
        // Sistemas integrados
        let stampCache = null;
        let apiOptimizer = null;
        let rateLimiter = null;
        let analytics = null;
        
        // Analytics
        function trackEvent(event, data = {}) {
            if (!CONFIG.analyticsEnabled) return;
            
            console.log('📊 Analytics:', event, data);
            // Aqui você pode integrar com Google Analytics, Mixpanel, etc.
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Inicializa sistemas
                await initializeSystems();
                
                // Configura UI
                loadAvatar();
                setupEventListeners();
                
                // Analytics
                if (analytics) {
                    analytics.trackEmbedLoaded();
                }
                
                console.log('✅ EstampAI Mobile inicializado');
            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
            }
        });
        
        async function initializeSystems() {
            // Gera ID do usuário
            userId = generateUserId();
            
            // Inicializa cache
            if (CONFIG.cacheEnabled && window.StampCacheManager) {
                stampCache = new window.StampCacheManager();
                await stampCache.init();
                console.log('✅ Cache inicializado');
            }
            
            // Inicializa otimizador de API
            if (window.APIOptimizer) {
                apiOptimizer = new window.APIOptimizer();
                console.log('✅ API Optimizer inicializado');
            }
            
            // Inicializa rate limiter
            if (CONFIG.rateLimitEnabled && window.RateLimiter) {
                rateLimiter = new window.RateLimiter();
                console.log('✅ Rate Limiter inicializado');
            }
            
            // Inicializa analytics
            if (CONFIG.analyticsEnabled && window.Analytics) {
                analytics = new window.Analytics();
                console.log('✅ Analytics inicializado');
            }
        }
        
        function generateUserId() {
            let userId = localStorage.getItem('estampai_user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('estampai_user_id', userId);
            }
            return userId;
        }
        
        function setupEventListeners() {
            const input = document.getElementById('messageInput');
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            input.addEventListener('input', function() {
                // Auto-resize textarea
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 80) + 'px';
            });
        }
        
        function loadAvatar() {
            const canvas = document.getElementById('avatarCanvas');
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = 'https://estampai.onrender.chttps://estampai.onrender.com/AVATAR.png';
        }
        
        function addMessage(type, content) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatar = type === 'user' ? '👤' : '🤖';
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content}</div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // Adiciona ao histórico
            conversationHistory.push({
                role: type === 'user' ? 'user' : 'assistant',
                content: content,
                timestamp: new Date()
            });
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loadingMessage');
            const avatarCanvas = document.getElementById('avatarCanvas');
            const stampCanvas = document.getElementById('stampCanvas');
            
            if (show) {
                loading.style.display = 'flex';
                avatarCanvas.style.display = 'none';
                stampCanvas.style.display = 'none';
            } else {
                loading.style.display = 'none';
                avatarCanvas.style.display = 'block';
                stampCanvas.style.display = 'none';
            }
        }
        
        function showView(view) {
            // Atualiza tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Mostra canvas correto
            const avatarCanvas = document.getElementById('avatarCanvas');
            const stampCanvas = document.getElementById('stampCanvas');
            
            if (view === 'avatar') {
                avatarCanvas.style.display = 'block';
                stampCanvas.style.display = 'none';
            } else {
                avatarCanvas.style.display = 'none';
                stampCanvas.style.display = 'block';
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isGenerating) return; isGenerating = true;
            
            // Verifica rate limiting
            if (rateLimiter) {
                const rateCheck = rateLimiter.canProceed(userId, 'chat');
                if (!rateCheck.allowed) {
                    const resetTime = new Date(rateCheck.resetTime);
                    addMessage('ai', `Muitas mensagens! Tente novamente em ${resetTime.toLocaleTimeString()}`);
                    return;
                }
            }
            
            // Adiciona mensagem do usuário
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';
            
            // Mostra loading
            addMessage('ai', '🤔 Pensando...');
            
            try {
                // Chat com IA (com debounce)
                const debouncedChat = apiOptimizer && typeof apiOptimizer.debounce === 'function' ? 
                    apiOptimizer.debounce(chatWithAI, 500) : 
                    chatWithAI;
                
                const response = await debouncedChat(message);
                
                // Remove loading e adiciona resposta
                const messages = document.getElementById('messagesContainer');
                if (messages && messages.lastChild) { messages.removeChild(messages.lastChild); }
                addMessage('ai', response);
                
                // Analytics
                if (analytics) {
                    analytics.trackMessageSent(message);
                }
                
            } catch (error) {
                console.error('Erro no chat:', error);
                const messages = document.getElementById('messagesContainer');
                if (messages && messages.lastChild) { messages.removeChild(messages.lastChild); }
                addMessage('ai', 'Desculpe, estou com dificuldades técnicas. Tente novamente!');
                
                // Analytics de erro
                if (analytics) {
                    analytics.trackError(error, 'chat');
                }
            }
        }
        
        async function generateStamp() {
            if (isGenerating) return;
            
            // Verifica rate limiting
            if (rateLimiter) {
                const rateCheck = rateLimiter.canProceed(userId, 'stamp');
                if (!rateCheck.allowed) {
                    const resetTime = new Date(rateCheck.resetTime);
                    addMessage('ai', `Muitas estampas geradas! Tente novamente em ${resetTime.toLocaleTimeString()}`);
                    return;
                }
            }
            
            // Verifica limite freemium
            if (stampsGenerated >= CONFIG.maxStamps) {
                addMessage('ai', `Você já gerou ${CONFIG.maxStamps} estampas gratuitas! Entre em contato para gerar mais.`);
                return;
            }
            
            isGenerating = true;
            showLoading(true);
            
            try {
                // Extrai contexto da conversa
                const prompt = await extractStampContext();
                if (!prompt) {
                    addMessage('ai', 'Preciso de mais detalhes! Me conte sobre o que você quer na estampa: dragão, caveira, símbolo, etc.');
                    showLoading(false);
                    isGenerating = false;
                    return;
                }
                
                // Verifica cache primeiro
                let imageUrl = null;
                if (stampCache) {
                    const cachedStamp = await stampCache.getCachedStamp(prompt);
                    if (cachedStamp) {
                        imageUrl = cachedStamp.imageUrl;
                        console.log('🎯 Usando estampa do cache');
                    }
                }
                
                // Gera estampa se não encontrou no cache
                if (!imageUrl) {
                    imageUrl = await generateStampWithAI(prompt);
                    
                    // Salva no cache
                    if (stampCache) {
                        await stampCache.saveStamp(prompt, imageUrl, {
                            userId: userId,
                            timestamp: Date.now()
                        });
                    }
                }
                
                // Aplica no avatar
                applyStampToAvatar(imageUrl);
                
                // Atualiza contador
                stampsGenerated++;
                currentStamp = imageUrl;
                
                // Habilita download
                document.getElementById('downloadBtn').disabled = false;
                
                addMessage('ai', '✨ Pronto! Sua estampa foi criada!');
                
                // Analytics
                if (analytics) {
                    analytics.trackStampGenerated(prompt, true);
                }
                
            } catch (error) {
                console.error('Erro ao gerar estampa:', error);
                addMessage('ai', 'Desculpe, não consegui gerar sua estampa. Tente novamente!');
                
                // Analytics de erro
                if (analytics) {
                    analytics.trackError(error, 'stamp_generation');
                }
            } finally {
                showLoading(false);
                isGenerating = false;
            }
        }
        
        async function chatWithAI(message) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4',
                    messages: [
                        {
                            role: 'system',
                            content: `Você é a EstampAI, uma assistente especializada em criação de estampas para camisetas. 

Sua personalidade:
- Criativa e entusiasmada
- Conhece tendências de moda e streetwear
- Ajuda a refinar ideias de estampas
- Faz perguntas para entender melhor o que o usuário quer
- Sugere melhorias e variações

IMPORTANTE: Só sugira gerar a estampa quando o usuário mencionar elementos específicos como:
- Dragão, caveira, cruz, fogo, moto, carro, brasão, símbolo, logo, ícone
- Ou quando o usuário explicitamente pedir para gerar

Quando o usuário mencionar uma ideia de estampa:
1. Faça perguntas para entender melhor (estilo, cores, público-alvo)
2. Sugira melhorias ou variações
3. Só pergunte se quer gerar quando tiver elementos específicos

Seja conversacional e amigável!`
                        },
                        ...conversationHistory.filter(msg => msg && msg.role && msg.content).slice(-10)
                    ],
                    max_tokens: 200,
                    temperature: 0.8
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text().catch(() => 'Erro desconhecido'); throw new Error(`Erro da API: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        async function extractStampContext() {
            if (conversationHistory.length < 2) {
                return conversationHistory[conversationHistory.length - 1]?.content || '';
            }
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            {
                                role: 'system',
                                content: `Você é um especialista em extrair informações relevantes para criação de estampas.

Sua tarefa: Analisar a conversa e extrair APENAS os elementos visuais específicos que devem aparecer na estampa.

INSTRUÇÕES:
1. Identifique elementos visuais específicos (objetos, pessoas, animais, símbolos, etc.)
2. Identifique estilo visual (vintage, minimalista, realista, cartoon, etc.)
3. Identifique cores mencionadas
4. Identifique composição (centralizada, grande, pequena, etc.)
5. IGNORE informações sobre público-alvo, marca, negócio, etc.

FORMATO DE RESPOSTA:
Se houver elementos visuais específicos, retorne APENAS uma descrição concisa dos elementos visuais.
Se NÃO houver elementos visuais específicos, retorne "INSUFICIENTE".

EXEMPLOS:
- "dragão flamejante em estilo vintage"
- "caveira punk com espinhos em preto e branco"
- "jogador de futebol em estádio com bandeiras do Brasil no estilo pôster vintage"
- "INSUFICIENTE" (se só mencionar "marca", "negócio", "público-alvo", etc.)`
                            },
                            {
                                role: 'user',
                                content: `Analise esta conversa e extraia os elementos visuais para estampa:\n\n${conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}`
                            }
                        ],
                        max_tokens: 80,
                        temperature: 0.3
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Erro desconhecido'); throw new Error(`Erro da API: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                const extractedPrompt = data.choices[0].message.content.trim();
                
                if (extractedPrompt === 'INSUFICIENTE') {
                    return null;
                }
                
                return extractedPrompt;
                
            } catch (error) {
                console.error('Erro ao extrair contexto:', error);
                const userMessages = conversationHistory
                    .filter(msg => msg.role === 'user')
                    .map(msg => msg.content)
                    .join(' ');
                return userMessages;
            }
        }
        
        async function generateStampWithAI(prompt) {
            // Otimiza prompt se disponível
            const optimizedPrompt = apiOptimizer && typeof apiOptimizer.debounce === 'function' ? 
                apiOptimizer.optimizePrompt(prompt) : 
                prompt;
            
            const fullPrompt = `Ilustração isolada de ${optimizedPrompt}

Fundo: PRETO SÓLIDO

Especificações técnicas:
- Formato: Quadrado 1024x1024px
- Resolução: Alta qualidade (HD)
- Estilo: Moderno, dinâmico e versátil
- Cores: Vibrantes e contrastantes
- Composição: Centralizada e equilibrada

NÃO incluir:
- Camiseta, roupa, mockup, produto ou manequim
- Fundo colorido ou padrão
- Texto ou tipografia
- Bordas ou molduras
- Elementos de design de produto

RESULTADO: Ilustração isolada, fundo preto sólido, alta qualidade, perfeita para estampa de camiseta.`;
            
            // Usa retry com backoff se disponível
            const makeRequest = () => fetch('https://api.openai.com/v1/images/generations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: 'dall-e-3',
                    prompt: fullPrompt,
                    n: 1,
                    size: '1024x1024',
                    response_format: 'url'
                })
            });
            
            const response = apiOptimizer && typeof apiOptimizer.debounce === 'function' ? 
                await apiOptimizer.retryRequest(makeRequest) : 
                await makeRequest();
            
            if (!response.ok) {
                const errorText = await response.text().catch(() => 'Erro desconhecido'); throw new Error(`Erro da API: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            return data.data[0].url;
        }
        
        function applyStampToAvatar(imageUrl) {
            const container = document.querySelector('.preview-container');
            
            // Remove estampa anterior
            const existingStamp = document.getElementById('stampOverlay');
            if (existingStamp) {
                existingStamp.remove();
            }
            
            // Cria nova estampa
            const stampImg = document.createElement('img');
            stampImg.id = 'stampOverlay';
            stampImg.className = 'stamp-overlay';
            stampImg.src = imageUrl;
            stampImg.alt = 'Estampa gerada';
            
            stampImg.onload = function() {
                console.log('✅ Estampa aplicada no avatar');
            };
            
            stampImg.onerror = function() {
                console.error('❌ Erro ao carregar estampa');
                stampImg.remove();
            };
            
            container.appendChild(stampImg);
            
            // Também desenha no canvas de estampa
            const stampCanvas = document.getElementById('stampCanvas');
            const ctx = stampCanvas.getContext('2d');
            const canvasImg = new Image();
            canvasImg.onload = function() {
                ctx.clearRect(0, 0, stampCanvas.width, stampCanvas.height);
                ctx.drawImage(canvasImg, 0, 0, stampCanvas.width, stampCanvas.height);
            };
            canvasImg.src = imageUrl;
        }
        
        function downloadStamp() {
            if (!currentStamp) return;
            
            const link = document.createElement('a');
            link.href = currentStamp;
            link.download = `estampa-${Date.now()}.png`;
            link.click();
            
            // Analytics
            if (analytics) {
                analytics.trackStampDownloaded();
            }
            
            // Conversão
            if (analytics) {
                analytics.trackConversion('download', 1);
            }
        }
    </script>
</body>
</html>
